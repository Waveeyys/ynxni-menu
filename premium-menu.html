<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIA Premium Menu</title>
    <!-- Load Google Font: Electrolize (Sleek, High-Tech, Angular) -->
    <link href="https://fonts.googleapis.com/css2?family=Electrolize&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for a darker, sleek look */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2); /* Darker track */
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #444; /* Dark gray thumb */
            border-radius: 3px;
        }

        /* Basic container styling */
        body {
            /* Fallback background for preview */
            background-color: transparent; 
            color: white;
            font-family: 'Electrolize', sans-serif;
            margin: 0;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding-left: 5rem;
            user-select: none;
            overflow: hidden;
        }

        /* Keyframes for simple fade/slide-in */
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        
        /* * HIGHLY RELIABLE SLIDER FIX: 
        * The track is w-10 (~40px) and the thumb is w-3 (~12px). 
        * 25px is the correct visual translation to hit the right edge.
        */
        .toggle-thumb-on {
            transform: translateX(25px); /* Explicit pixel value for reliable translation */
        }

        /* Set a dark background only in local preview mode */
        body:not([data-nui-mode="true"]) {
            background-color: #111;
        }

    </style>
</head>
<body>

    <div id="app-container" class="relative flex items-start gap-4">
        <!-- Menu and Info Box will be rendered here -->
    </div>

    <script>
        // --- NUI Interaction Helpers (CRITICAL FOR FIVEM) ---
        
        // Checks if we are running inside the FiveM/RedM NUI browser
        const isNUI = () => typeof window.GetParentResourceName === 'function';

        /**
         * Sends a message back to the FiveM/RedM Lua client script.
         * @param {string} type - The type of action performed (e.g., 'closeMenu', 'toggleAction', 'menuAction').
         * @param {any} data - The associated data (e.g., { action: 'ToggleGodmode', value: true }).
         */
        const postMessage = (type, data = {}) => {
            if (isNUI()) {
                // IMPORTANT: The fetch URL maps to the RegisterNUICallback name in Lua
                fetch(`https://${window.GetParentResourceName()}/${type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                    },
                    body: JSON.stringify(data),
                }).catch(error => {
                    // console.error('NUI Fetch Error:', error); 
                });
            } else {
                // Mock console log for local browser/preview
                if (type === 'closeMenu') {
                    state.menuVisible = false;
                    render();
                }
                console.log(`[NUI Mock Post] Type: ${type}, Data:`, data);
            }
        };

        // --- Configuration ---
        const HEADER_BANNER = "https://i.ibb.co/6JphhX1G/Menu-Banner3.png";

        // --- Menu Data Definitions (Aligned with Premium Structure) ---
        // item: action to trigger once
        const item = (label, action, props = {}) => ({ label, type: 'action', action: action || label.replace(/\s/g, ''), ...props });
        // submenu: opens a new level of menu
        const submenu = (label, items, props = {}) => ({ label, type: 'submenu', items, ...props });
        // toggle: sends a true/false state to Lua
        const toggle = (label, action, props = {}) => ({ label, type: 'toggle', action: action || 'Toggle' + label.replace(/\s/g, ''), value: false, ...props });
        // slider: sends a numerical value to Lua
        const slider = (label, action, min, max, initial, props = {}) => ({ label, type: 'slider', action: action || 'Slider' + label.replace(/\s/g, ''), min, max, value: initial, ...props });

        // --- SUBMENUS (Matches GIA_HTML_Menu.lua / testingpremium.html structure) ---

        // Local > Player > Player Options
        const playerOptions = [
            toggle('Godmode', 'ToggleGodmode'),
            slider('Quick Regen', 'SliderQuickRegen', 1, 2, 1),
            item('Heal Player', 'HealPlayer'), 
            item('Give Armour', 'GiveArmour'),
            item('Clean Player', 'CleanPlayer'),
            toggle('Auto Clean', 'ToggleAutoClean'),
        ];
        
        // Local > Player > Movement
        const playerMovement = [
            toggle('No Clip', 'ToggleNoClip', { description: 'Fly through objects, without T Posing, your player is still running.' }),
            slider('No Clip Speed', 'SliderNoClipSpeed', 1, 10, 1),
            toggle('No Collisions', 'ToggleNoCollisions', { description: 'Phase through any native object.' }),
            toggle('Invisibility', 'ToggleInvisibility'),
            toggle('Player Visible Locally', 'ToggleVisibleLocally', { description: 'You are invisible to other players.' }),
            toggle('Super Run', 'ToggleSuperRun'),
            slider('Swim Speed', 'SliderSwimSpeed', 1, 20, 10),
            toggle('Super Jump', 'ToggleSuperJump'),
            toggle('Super Flight', 'ToggleSuperFlight'),
            toggle('Explosive Melee', 'ToggleExplosiveMelee'),
            toggle('Seatbelt', 'ToggleSeatbelt', { description: 'For vehicles.' }),
            toggle('No Ragdoll', 'ToggleNoRagdoll'),
            toggle('Infinite Stamina', 'ToggleInfiniteStamina'),
            item('Clone Bodyguard', 'CloneBodyguard', { description: 'Clones a bodyguard of you.' }),
            slider('Damage Modifier', 'SliderDamageMod', 1, 5, 1),
            slider('Melee Damage Modifier', 'SliderMeleeDamageMod', 1, 5, 1),
            item('Suicide', 'KillPlayer', { description: 'Kills your player.' }),
        ];

        // Local > Vehicle
        const vehicleOptions = [
            item('Repair Vehicle', 'RepairVehicle'), 
            item('Upgrade Vehicle', 'UpgradeVehicle'),
            toggle('Vehicle Godmode', 'ToggleVehicleGodmode'),
            item('Toggle Engine', 'ToggleEngine'),
            item('Max Vehicle', 'MaxVehicle'),
            item('Clean Vehicle', 'CleanVehicle'),
            toggle('Vehicle Boost', 'ToggleVehicleBoost'),
            slider('Boost Strength', 'SliderBoostStrength', 1, 100, 50),
            toggle('Auto Repair', 'ToggleAutoRepair'),
        ];

        // Local > Weapons
        const weaponsOptions = [
            item('Give All Weapons', 'GiveAllWeapons'),
            toggle('Infinite Ammo', 'ToggleInfiniteAmmo'),
            toggle('No Recoil', 'ToggleNoRecoil'),
            toggle('No Reload', 'ToggleNoReload'),
            toggle('Explosive Ammo', 'ToggleExplosiveAmmo'),
            slider('Weapon Damage Mod', 'SliderWeaponDamageMod', 1, 10, 1),
            submenu('Aimbot', [
                toggle('Silent Aim', 'ToggleSilentAim'),
                toggle('No Spread', 'ToggleNoSpread'),
                toggle('Aim Lock', 'ToggleAimLock'),
                toggle('Show FOV', 'ToggleShowFOV'),
            ]),
        ];
        
        // Local > World
        const worldOptions = [
            item('Set Weather Sunny', 'SetWeatherSunny'),
            item('Time Skip +1 Hour', 'TimeSkip'),
            toggle('Freeze Time', 'ToggleFreezeTime'),
            toggle('Disable Traffic', 'ToggleDisableTraffic'),
            toggle('Disable Peds', 'ToggleDisablePeds'),
            item('Clear Area', 'ClearArea'),
        ];

        // --- MAIN TABS ---

        let MENU_DATA = {
            Local: [
                submenu('Player', [
                    submenu('Player Options', playerOptions, { 
                        description: 'Basic features directly related to your player ped.' 
                    }),
                    submenu('Movement', playerMovement, {
                         description: 'Movement and physics-related player adjustments.'
                    }),
                    submenu('Model Changer', [item('Reset Skin', 'ResetSkin'), item('Input Custom Model', 'InputCustomModel')]),
                    submenu('Outfitter', [item('Open Wardrobe', 'OpenWardrobe')]),
                    submenu('Animations', [item('Stop Animation', 'StopAnimation')]),
                    submenu('PTFX', [item('Stop All PTFX', 'StopPTFX')]),
                    submenu('Teleport', [item('To Waypoint', 'TeleportToWaypoint'), item('To Objective', 'TeleportToObjective')]),
                ]),
                submenu('Vehicle', vehicleOptions),
                submenu('Weapons', weaponsOptions),
                submenu('World', worldOptions),
                submenu('Visuals', [
                    toggle('ESP Boxes', 'ToggleESPBoxes'),
                    toggle('ESP Names', 'ToggleESPNames'),
                    toggle('ESP Health', 'ToggleESPHealth'),
                    toggle('ESP Armour', 'ToggleESPArmour'),
                ]),
                submenu('Misc', [
                    item('Cayo Perico Heist Prep Skip', 'CayoSkip'),
                    item('Casino Heist Prep Skip', 'CasinoSkip'),
                    item('Unlock All LSCustoms', 'UnlockLSCustoms'),
                    item('Bunker Research Skip', 'BunkerSkip'),
                    toggle('Auto Rob', 'ToggleAutoRob'),
                ]),
                submenu('Settings', []), // Empty for now
            ],
            Online: [
                submenu('Online Players', [
                    item('List Players...', 'ListPlayers'),
                    item('Selected Player Options...', 'PlayerOptionsSelected'),
                ]),
                submenu('Lobby', [
                    item('Clear Weather', 'ClearWeatherLobby'),
                    item('Max Lobby Speed', 'MaxLobbySpeed'),
                    item('Kick All', 'KickAll'),
                ]),
                submenu('Modder Detection', [
                    toggle('Auto Detect', 'ToggleModderDetect'),
                    item('Scan Lobby', 'ScanLobby'),
                ]),
                submenu('Settings', []),
            ],
            Spawn: [
                submenu('Vehicles', [item('Spawn Car', 'SpawnCar'), item('Spawn Plane', 'SpawnPlane')]),
                submenu('Objects', [item('Spawn Ramp', 'SpawnRamp'), item('Spawn Box', 'SpawnBox')]),
                submenu('Peds', [item('Spawn Guard', 'SpawnGuard'), item('Spawn Hostile', 'SpawnHostile')]),
                submenu('Editor', [item('Open Editor', 'OpenEditor')]),
            ]
        };

        const TABS = Object.keys(MENU_DATA);

        // --- State Management ---
        let state = {
            menuVisible: !isNUI(), 
            activeTab: 0,
            navStack: [], // Stores { title, items, previousIndex }
            selectedIndex: 0,
        };

        // --- Derived State & Helpers ---

        function isRoot() {
            return state.navStack.length === 0;
        }

        function getCurrentViewItems() {
            // Get items from the top of the stack or the root tab data
            return state.navStack.length > 0
                ? state.navStack[state.navStack.length - 1].items
                : MENU_DATA[TABS[state.activeTab]];
        }

        function getCurrentHeader() {
            // Get title from the top of the stack or the active tab name
            return state.navStack.length > 0 ? state.navStack[state.navStack.length - 1].title : TABS[state.activeTab];
        }

        function getSelectedItem() {
            const items = getCurrentViewItems();
            return items[state.selectedIndex];
        }

        // Deeply clone and update item state
        function updateItemState(index, updates) {
            // Determine if we are updating an item in the stack or in the root data
            if (state.navStack.length > 0) {
                 const activeLayer = state.navStack[state.navStack.length - 1];
                 const newItems = [...activeLayer.items];
                 newItems[index] = { ...newItems[index], ...updates };
                 activeLayer.items = newItems; // Update the reference in the stack
            } else {
                const newItems = [...MENU_DATA[TABS[state.activeTab]]];
                newItems[index] = { ...newItems[index], ...updates };
                MENU_DATA[TABS[state.activeTab]] = newItems; // Update the root data
            }
            render();
        }
        
        // --- Rendering Functions ---

        function renderValue(item) {
            if (item.type === 'toggle') {
                const checked = item.value;
                // Use red for OFF, green for ON for the background track
                const trackClass = checked ? 'bg-green-600' : 'bg-red-600';
                
                // Use the custom CSS class 'toggle-thumb-on'
                const sliderClass = checked ? 'toggle-thumb-on' : 'translate-x-0';
                
                return `
                    <!-- Visual Thumb Slider (using custom CSS class for reliability) -->
                    <div class="relative w-10 h-4 rounded-full ${trackClass} transition-all duration-300 flex items-center p-0.5">
                        <!-- Thumb/Handle -->
                        <div class="absolute w-3 h-3 rounded-full bg-white shadow-md transform ${sliderClass} transition-all duration-300"></div>
                    </div>
                `;
            }
            if (item.type === 'slider') {
                return `<span class="font-mono text-xs text-gray-400">{< ${item.value} >}</span>`;
            }
            if (item.type === 'submenu') {
                return `<span class="font-bold text-[10px] tracking-tighter text-gray-400">>></span>`;
            }
            return '';
        }

        function renderTabs() {
            if (!isRoot()) return '';

            return `
                <div class="absolute bottom-0 left-0 w-full flex px-2 gap-1 bg-gradient-to-t from-black/80 to-transparent pt-4">
                    ${TABS.map((tab, index) => `
                        <div
                            data-tab-index="${index}"
                            class="flex-1 text-center py-1 cursor-pointer transition-colors duration-150 uppercase tracking-wide text-xs font-semibold z-10 
                            ${state.activeTab === index 
                                ? 'bg-gradient-to-b from-gray-200 to-gray-400 text-black shadow-lg' 
                                : 'text-gray-300 hover:text-white bg-black/40'}
                            "
                            onclick="handleTabClick(${index})"
                        >
                            ${tab}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderHeader() {
            const currentHeader = getCurrentHeader();
            return `
                <div class="h-24 relative bg-black border-b border-white/10 shrink-0">
                    <img src="${HEADER_BANNER}" alt="Banner" class="w-full h-full object-cover opacity-90" 
                        onerror="this.onerror=null; this.src='https://placehold.co/320x96/111827/ffffff?text=GIA+Menu+Header';"
                    />
                    
                    ${isRoot() ? renderTabs() : `
                        <div class="absolute bottom-0 left-0 w-full bg-black/80 text-white px-3 py-1 text-xs font-bold border-t border-white/20">
                            ${currentHeader}
                        </div>
                    `}
                </div>
            `;
        }

        function renderList() {
            const currentViewItems = getCurrentViewItems();
            
            const listHTML = currentViewItems.map((item, index) => `
                <div
                    data-item-index="${index}"
                    class="menu-item px-3 py-1 flex items-center justify-between cursor-pointer transition-all duration-75 shrink-0
                    ${state.selectedIndex === index 
                        ? 'bg-white text-black font-semibold' 
                        : 'text-gray-200 hover:bg-white/10'}
                    "
                    onmouseenter="setSelectedIndex(${index})"
                    onclick="handleItemSelect()"
                >
                    <span class="truncate pr-2">${item.label}</span>
                    <div class="flex items-center gap-2">
                        ${renderValue(item)}
                    </div>
                </div>
            `).join('');

            return `
                <div id="menu-list" class="bg-black/95 h-[400px] overflow-y-auto flex flex-col py-2 scrollbar-thin pr-1">
                    ${listHTML}
                    
                    ${currentViewItems.length === 0 ? `
                        <div class="text-gray-500 text-xs text-center py-4 italic">No Options</div>
                    ` : ''}
                </div>
            `;
        }

        function renderFooter() {
            return `
                <div class="bg-black text-gray-400 text-[10px] px-2 py-1 flex justify-between items-center border-t border-white/20 shrink-0">
                    <span>GIA Premium</span>
                    <span>v3.0.1</span>
                </div>
            `;
        }

        function renderInfoBox() {
            const selectedItem = getSelectedItem();
            if (!selectedItem || !selectedItem.description) return '';

            return `
                <div class="w-[280px] bg-black/90 p-4 border-l-4 border-white/20 text-white shadow-xl animate-fade-in mt-24">
                    <div class="text-xs leading-relaxed text-gray-300">
                        ${selectedItem.description}
                    </div>
                    ${selectedItem.warning ? `
                        <div class="mt-3 text-xs text-yellow-500 font-medium leading-relaxed">
                            ${selectedItem.warning}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderMenu() {
            const menuHTML = `
                <div class="w-[320px] flex flex-col shadow-2xl animate-fade-in">
                    ${renderHeader()}
                    ${renderList()}
                    ${renderFooter()}
                </div>
            `;

            return `
                ${menuHTML}
                ${renderInfoBox()}
            `;
        }

        function render() {
            const container = document.getElementById('app-container');
            if (!container) return;
            
            if (state.menuVisible) {
                container.innerHTML = renderMenu();
                autoScroll();
            } else {
                container.innerHTML = '';
            }
        }

        // --- Interaction Logic (Vanilla JS Functions) ---

        function autoScroll() {
            const listRef = document.getElementById('menu-list');
            const items = listRef ? listRef.querySelectorAll('.menu-item') : [];
            const el = items[state.selectedIndex];

            if (el && listRef) {
                const elTop = el.offsetTop;
                const elBottom = elTop + el.clientHeight;
                const containerTop = listRef.scrollTop;
                const containerBottom = containerTop + listRef.clientHeight;
                
                // Scroll up if item is above view
                if (elTop < containerTop) {
                    listRef.scrollTop = elTop;
                // Scroll down if item is below view
                } else if (elBottom > containerBottom) {
                    listRef.scrollTop = elBottom - listRef.clientHeight;
                }
            }
        }
        
        function setSelectedIndex(newIndex) {
             if (state.selectedIndex !== newIndex) {
                state.selectedIndex = newIndex;
                render();
            }
        }

        function handleTabClick(index) {
            state.activeTab = index;
            state.selectedIndex = 0;
            state.navStack = []; // Clear stack when changing tabs
            render();
        }

        function enterSubmenu(item) {
            state.navStack.push({
                title: item.label,
                items: item.items,
                previousIndex: state.selectedIndex 
            });
            state.selectedIndex = 0;
            render();
        }

        function goBack() {
            if (state.navStack.length > 0) {
                const prevStack = state.navStack.pop();
                state.selectedIndex = prevStack.previousIndex || 0;
                render();
            } else {
                // If on the root menu and pressing back/escape, close the NUI
                postMessage('closeMenu');
            }
        }
        
        function handleItemSelect() {
            const currentItem = getSelectedItem();
            if (!currentItem) return;

            if (currentItem.type === 'submenu') {
                enterSubmenu(currentItem);
            } else if (currentItem.type === 'toggle') {
                const newValue = !currentItem.value;
                updateItemState(state.selectedIndex, { value: newValue });
                // Send action to Lua: type is 'toggleAction', data includes the specific 'action' and the new value.
                postMessage('toggleAction', { action: currentItem.action, value: newValue });
            } else if (currentItem.type === 'action') {
                // Send action to Lua: type is 'menuAction', data includes the specific 'action'.
                postMessage('menuAction', { action: currentItem.action });
            }
        }

        // --- NUI Message Listener (CRITICAL) ---
        window.addEventListener('message', function(event) {
            const item = event.data;
            
            if (item.action === 'setVisibility') {
                // This is the primary control message from Lua
                state.menuVisible = item.visible;
                if (item.visible) {
                    // Reset menu state when opening
                    state.navStack = [];
                    state.selectedIndex = 0;
                    state.activeTab = 0;
                }
                render();
            } else if (item.action === 'close') {
                state.menuVisible = false;
                render();
            }
        });

        // --- Keyboard Handler ---
        document.addEventListener('keydown', function(e) {
            if (!state.menuVisible) return;

            const currentViewItems = getCurrentViewItems();
            if (currentViewItems.length === 0) return;
            
            const currentItem = getSelectedItem();

            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                    e.preventDefault();
                    state.selectedIndex = state.selectedIndex > 0 ? state.selectedIndex - 1 : currentViewItems.length - 1;
                    render();
                    break;
                    
                case 'ArrowDown':
                case 's':
                    e.preventDefault();
                    state.selectedIndex = state.selectedIndex < currentViewItems.length - 1 ? state.selectedIndex + 1 : 0;
                    render();
                    break;

                case 'ArrowLeft':
                case 'a':
                    e.preventDefault();
                    if (currentItem?.type === 'slider') {
                        const newVal = Math.max(currentItem.min, currentItem.value - 1);
                        updateItemState(state.selectedIndex, { value: newVal });
                        postMessage('sliderChange', { action: currentItem.action, value: newVal });
                    } else {
                        goBack(); // Back/Escape functionality
                    }
                    break;

                case 'ArrowRight':
                case 'd':
                    e.preventDefault();
                    if (currentItem?.type === 'slider') {
                        const newVal = Math.min(currentItem.max, currentItem.value + 1);
                        updateItemState(state.selectedIndex, { value: newVal });
                        postMessage('sliderChange', { action: currentItem.action, value: newVal });
                    } else if (currentItem?.type === 'submenu') {
                        enterSubmenu(currentItem);
                    } else if (isRoot()) {
                         // Tab switching on right arrow at the root level
                        state.activeTab = state.activeTab < TABS.length - 1 ? state.activeTab + 1 : 0;
                        state.selectedIndex = 0;
                        render();
                    }
                    break;

                case 'Enter':
                    e.preventDefault();
                    handleItemSelect();
                    break;

                case 'Backspace':
                case 'Escape': 
                    e.preventDefault();
                    goBack();
                    break;

                default:
                    break;
            }
        });


        // --- Initial Load ---
        window.onload = function() {
            // Set up body attribute for CSS handling based on NUI environment
            document.body.setAttribute('data-nui-mode', isNUI() ? 'true' : 'false');
            render();
            if (!isNUI()) {
                console.log("Running in local preview mode. Use Arrow Keys and Enter/Backspace to navigate.");
            }
        };
    </script>
</body>
</html>
